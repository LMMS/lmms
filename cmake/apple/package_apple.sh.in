#!/bin/bash
# Creates Apple ".app" bundle for @PROJECT_NAME_UCASE@
# Note:
#   Examine linkings using `otool -L somelib.so`
#   Debug the loading of dynamic libraries using `export DYLD_PRINT_LIBRARIES=1`

set -e

MSG_COLOR='\x1B[1;36m'
COLOR_RESET='\x1B[0m'
APP="$1/@PROJECT_NAME_UCASE@.app"
echo -e "$MSG_COLOR\n\nCreating App Bundle \"$APP\"...$COLOR_RESET"

qtpath="$(dirname "@QT_QMAKE_EXECUTABLE@")"
export PATH="$PATH:$qtpath"

# Ensure an install path was passed in
if [ -z "$1" ]; then
	echo "An install folder was not provided"
	exit 1
fi

if [ -d "$1" ]; then
	echo "Directory $1 exists, using..."
else
	echo "Provided directory '$1' does not exist"
fi

# Create .app bundle containing contents from CPack's "External" install directory
mkdir -p "$APP/Contents/MacOS"
mkdir -p "$APP/Contents/Frameworks"
mkdir -p "$APP/Contents/Resources"
cd "$1"
for file in *; do
    if [ "$(basename $file)" != "@PROJECT_NAME_UCASE@.app" ]; then
    	mv "$file" "$APP/Contents/"
    fi
done


cp "@CMAKE_BINARY_DIR@/Info.plist" "$APP/Contents/" # TODO: MOVE TO INSTALL
cp "@CMAKE_SOURCE_DIR@/cmake/apple/"*.icns "$APP/Contents/Resources/" # TODO: MOVE TO INSTALL

# Make all libraries writable for macdeployqt
cd "$APP"
find . -type f -print0 | xargs -0 chmod u+w

# Move lmms binary
mv "$APP/Contents/bin/@CMAKE_PROJECT_NAME@" "$APP/Contents/MacOS/@CMAKE_PROJECT_NAME@"
# shellcheck disable=SC2115
rm -rf "$APP/bin"

# Fix zyn linking
mv "$APP/Contents/lib/lmms/RemoteZynAddSubFx" "$APP/Contents/MacOS/RemoteZynAddSubFx"
  
# Replace @rpath with @loader_path for Carla
# See also plugins/CarlaBase/CMakeLists.txt
# This MUST be done BEFORE calling macdeployqt
install_name_tool -change @rpath/libcarlabase.dylib \
   @loader_path/libcarlabase.dylib \
  "$APP/Contents/lib/lmms/libcarlapatchbay.so"

install_name_tool -change @rpath/libcarlabase.dylib \
  @loader_path/libcarlabase.dylib \
  "$APP/Contents/lib/lmms/libcarlarack.so"

# Link lmms binary
_executables="${_executables} -executable=$APP/Contents/MacOS/RemoteZynAddSubFx"

# Build a list of shared objects in target/lib/lmms
for file in "$APP/Contents/lib/lmms/"*.so; do
   _thisfile="$APP/Contents/lib/lmms/${file##*/}"
   _executables="${_executables} -executable=$_thisfile"
done

# Build a list of shared objects in target/lib/lmms/ladspa
for file in "$APP/Contents/lib/lmms/ladspa/"*.so; do
   _thisfile="$APP/Contents/lib/lmms/ladspa/${file##*/}"
   _executables="${_executables} -executable=$_thisfile"
done

# Finalize .app
# shellcheck disable=SC2086
macdeployqt "$APP" $_executables

# Carla is a standalone plugin.  Remove library, look for it side-by-side LMMS.app
# This MUST be done AFTER calling macdeployqt
#
# For example:
#    /Applications/LMMS.app
#    /Applications/Carla.app
carlalibs=$(echo "@CARLA_LIBRARIES@"|tr ";" "\n")

# Loop over all libcarlas, fix linking
for file in "$APP/Contents/lib/lmms/"libcarla*; do
   _thisfile="$APP/Contents/lib/lmms/${file##*/}"
   for lib in $carlalibs; do
     _oldpath="../../Frameworks/lib${lib}.dylib"
     _newpath="Carla.app/Contents/MacOS/lib${lib}.dylib"
     # shellcheck disable=SC2086
     install_name_tool -change @loader_path/$_oldpath \
       @executable_path/../../../$_newpath \
       "$_thisfile"
     rm -f "$APP/Contents/Frameworks/lib${lib}.dylib"
   done
done

# Codesign
codesign --force --deep --sign - "$APP"

echo -e "\nFinished.\n\n"
