version: 2
jobs:
  build:
    docker:
      - image: lukaswhl/lmms-ci-gcc
    steps:
      - checkout
      - restore_cache:
          keys:
            - ccache-{{ .Branch }}-{{ .BuildNum }}
            - ccache-{{ .Branch }}
            - ccache
      - run:
          name: Configuring
          command: mkdir build && cd build && cmake .. -DWANT_QT5=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo -DUSE_CCACHE=ON
      - run:
          name: Building
          command: cd build && make -j4
      - run:
          name: Building tests
          command: cd build && make tests
      - run:
          name: Running tests
          command: build/tests/tests
      - save_cache:
          key: ccache-{{ .Branch }}-{{ .BuildNum }}
          paths:
            - ~/.ccache
      - save_cache:
          key: ccache-{{ .Branch }}
          paths:
            - ~/.ccache
      - save_cache:
          key: ccache
          paths:
            - ~/.ccache
