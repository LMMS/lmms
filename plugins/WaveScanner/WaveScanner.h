/* * WaveScanner.h - The "Hyper Edition" (v4.1) * Features: 9-Voice Unison, Band-Limited Anti-Aliasing (MipMaps), Stereo Filters */#ifndef WAVE_SCANNER_H#define WAVE_SCANNER_H#include <vector>#include <memory> // Added for std::shared_ptr#include <QWidget>#include <QPainter>#include <QPushButton>#include "Instrument.h"#include "InstrumentView.h"#include "Graph.h"#include "AutomatableModel.h"#include "Knob.h"namespace lmms{namespace gui{    class WaveScannerView;    class ScannerKnob;    class LedCheckBox;    class SevenSegmentDisplay;}// =============================================================// AUDIO ENGINE// =============================================================// 1. MipMap Structure for Anti-Aliasingstruct WavetableMipMap {    // [MipLevel][FrameIndex][SampleIndex]    std::vector<std::vector<std::vector<float>>> levels;};// 2. ADSR Envelopeclass SimpleADSR{public:    SimpleADSR() : m_phase(0), m_val(0.0f) {}    void trigger() { m_phase = 1; m_val = 0.0f; }    void release() { m_phase = 4; }    float process(float a, float d, float s, float r, float sampleRate) {        if (m_phase == 0) return 0.0f;        float rate;        if (m_phase == 1) { // Attack            rate = 1.0f / (a * sampleRate + 1.0f);            m_val += rate;            if (m_val >= 1.0f) { m_val = 1.0f; m_phase = 2; }        }        else if (m_phase == 2) { // Decay            rate = 1.0f / (d * sampleRate + 1.0f);            m_val -= rate;            if (m_val <= s) { m_val = s; m_phase = 3; }        }        else if (m_phase == 3) { // Sustain            m_val = s;        }        else if (m_phase == 4) { // Release            rate = 1.0f / (r * sampleRate + 1.0f);            m_val -= rate;            if (m_val <= 0.0f) { m_val = 0.0f; m_phase = 0; }        }        return m_val * m_val;    }private:    int m_phase;    float m_val;};class WTSynth{public:    // CHANGED: Now accepts shared_ptr for thread safety    WTSynth(std::shared_ptr<const WavetableMipMap> map,             NotePlayHandle* _nph,             bool _vintageMode,            const sample_rate_t _sample_rate,            // Sub / OSC 2            float _subTune, float _subMix,             // Filter            float _cutoff, float _emphasis,            // Output            float _basis, float _stereoWidth,             // Unison            int _uniVoices, float _uniDetune, float _uniSpread,            // Modifiers            float _envA, float _envD, float _envS, float _envR,            float _modEnvWave, float _modEnvVcf,             float _modLfoWave, float _modLfoPitch, float _lfoSpeed           );    virtual ~WTSynth() = default;    void nextSample(float position_modulation, float pressure, float* outL, float* outR);    void release() { m_adsr.release(); }private:    // CHANGED: Holds a reference to the specific map version active when note started    std::shared_ptr<const WavetableMipMap> m_map;         NotePlayHandle* m_nph;    bool m_vintageMode;    const sample_rate_t m_sampleRate;    // Sub Oscillator    float m_subMix;    float m_subPhase;    float m_subStepFactor;    // Filter State (Dual Mono for Stereo Unison)    float m_fCutoff;    float m_fResonance;    float m_filterStateL[4];    float m_filterStateR[4];    // Unison Voice State    struct VoiceState {        float phase;        float speedScale;        float panL;        float panR;    };    std::vector<VoiceState> m_voices;    // Mod State    float m_lfoPhase;    float m_lfoSpeed;    float m_basis;    float m_stereoWidth;    // Envelopes    SimpleADSR m_adsr;    float m_envA, m_envD, m_envS, m_envR;    float m_modEnvWave;    float m_modEnvVcf;    float m_modLfoWave;    float m_modLfoPitch;};// =============================================================// INSTRUMENT MODEL// =============================================================class WaveScanner : public Instrument{    Q_OBJECTpublic:    WaveScanner(InstrumentTrack* _instrument_track);    ~WaveScanner() override = default;    void playNote(NotePlayHandle* _n, SampleFrame* _working_buffer) override;    void deleteNotePluginData(NotePlayHandle* _n) override;    void saveSettings(QDomDocument& _doc, QDomElement& _parent) override;    void loadSettings(const QDomElement& _this) override;    QString nodeName() const override;    gui::PluginView* instantiateView(QWidget* _parent) override;    static float getMathWave(int bank, int waveIndex, int sampleIndex, bool uwMode);protected slots:    void updateWavetable();    void updateVisuals();private:    // Digital Page    FloatModel m_wavePosition;    FloatModel m_sampleLength;    FloatModel m_bank;    BoolModel m_vintageMode;    BoolModel m_uwMode;    // Unison Page    FloatModel m_uniVoices;    FloatModel m_uniDetune;    FloatModel m_uniSpread;    FloatModel m_subMix;    FloatModel m_subTune;    // Shared / Filter    FloatModel m_filterCutoff;    FloatModel m_filterEmphasis;    FloatModel m_basis;    FloatModel m_stereoWidth;    // MODS Page    FloatModel m_envA, m_envD, m_envS, m_envR;    FloatModel m_modEnvWave;    FloatModel m_modEnvVcf;    FloatModel m_modLfoWave;    FloatModel m_modLfoPitch;    FloatModel m_lfoSpeed;    BoolModel m_modEnable;    // Graphs    graphModel m_graphStart;    graphModel m_graphEnd;    graphModel m_graphVisual;    // CHANGED: The Data is now a thread-safe shared pointer    std::shared_ptr<WavetableMipMap> m_currentMap;    friend class gui::WaveScannerView;    friend class WTSynth;};// =============================================================// GUI CLASSES// =============================================================namespace gui{class SevenSegmentDisplay : public QWidget{    Q_OBJECTpublic:    SevenSegmentDisplay(QWidget* parent);    void setValue(int v);protected:    void paintEvent(QPaintEvent* event) override;private:    int m_value;};// Renamed from PPGKnob to ScannerKnobclass ScannerKnob : public Knob{    Q_OBJECTpublic:    ScannerKnob(QWidget* parent, const QString& label);protected:    void paintEvent(QPaintEvent* event) override;private:    QString m_textLabel;};class WaveScannerView : public InstrumentViewFixedSize{    Q_OBJECTpublic:    WaveScannerView(Instrument* _instrument, QWidget* _parent);    ~WaveScannerView() override = default;protected:    // Removed paintEvent override here to allow artwork to show throughprivate slots:    void showPageDigital();    void showPageUnison();    void showPageMods();    void showGraphStart();    void showGraphEnd();private:    void modelChanged() override;    void updateVisibleWidgets();    QPushButton* m_btnTabDigital;    QPushButton* m_btnTabUnison;    QPushButton* m_btnTabMods;    int m_currentTab;    // -- DIGITAL PAGE --    QPushButton* m_btnShowStart;    QPushButton* m_btnShowEnd;    Graph* m_viewGraph;        ScannerKnob* m_positionKnob;     SevenSegmentDisplay* m_ledDisplay;    ScannerKnob* m_resKnob; // Grit    ScannerKnob* m_bankKnob;    LedCheckBox* m_vintageToggle;    LedCheckBox* m_uwToggle;    // -- UNISON PAGE --    ScannerKnob* m_uniVoicesKnob;    ScannerKnob* m_uniDetuneKnob;    ScannerKnob* m_uniSpreadKnob;    ScannerKnob* m_subMixKnob;    ScannerKnob* m_subTuneKnob;    ScannerKnob* m_vcfCutoffKnob;    ScannerKnob* m_vcfEmphasisKnob;    ScannerKnob* m_basisKnob;    // -- MODS PAGE --    LedCheckBox* m_modSwitch;    ScannerKnob* m_envAKnob;    ScannerKnob* m_envDKnob;    ScannerKnob* m_envSKnob;    ScannerKnob* m_envRKnob;    ScannerKnob* m_modEnvWaveKnob;    ScannerKnob* m_modEnvVcfKnob;    ScannerKnob* m_modLfoWaveKnob;    ScannerKnob* m_modLfoPitchKnob;    ScannerKnob* m_lfoSpeedKnob;};} // namespace gui} // namespace lmms#endif // WAVE_SCANNER_H