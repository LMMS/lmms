#include "SpectralGateControlDialog.h"#include "SpectralGateControls.h"#include "Knob.h"#include <QPushButton>#include <QGridLayout>#include <QLineEdit>#include <QLabel>#include <QGroupBox>#include <QVBoxLayout>namespace lmms::gui{SpectralGateControlDialog::SpectralGateControlDialog(SpectralGateControls* c) :    EffectControlDialog(c),    m_controls(c){    setMinimumSize(900, 540);     setWindowTitle("SpectralGate - EBM Morph");    QGridLayout* lay = new QGridLayout(this);    lay->setSpacing(10);    lay->setContentsMargins(15, 15, 15, 15);    // ============================================================    // ROW 0: GATE & GLOBAL DSP (Top Row)    // ============================================================    // All knobs centered in their columns    {        Knob* k = new Knob(KnobType::Bright26, "Pattern", this);        k->setModel(&c->m_patternModel);        lay->addWidget(k, 0, 0, Qt::AlignCenter);    }    {        // SPEED KNOB: Reverted to standard placement (no wrapper)        // We will align the PRESETS underneath this to match it.        Knob* k = new Knob(KnobType::Bright26, "Speed", this);        k->setModel(&c->m_speedModel);        lay->addWidget(k, 0, 1, Qt::AlignCenter);    }    {        Knob* k = new Knob(KnobType::Bright26, "Smooth", this);        k->setModel(&c->m_smoothModel);        lay->addWidget(k, 0, 2, Qt::AlignCenter);    }    {        Knob* k = new Knob(KnobType::Bright26, "Swing", this);        k->setModel(&c->m_swingModel);        lay->addWidget(k, 0, 3, Qt::AlignCenter);    }    {        Knob* k = new Knob(KnobType::Bright26, "Width", this);        k->setModel(&c->m_widthModel);        lay->addWidget(k, 0, 4, Qt::AlignCenter);    }    {        Knob* k = new Knob(KnobType::Bright26, "Decay", this);        k->setModel(&c->m_decayModel);        lay->addWidget(k, 0, 5, Qt::AlignCenter);    }    // ============================================================    // ROW 1: OPEN EQ (Middle Row)    // ============================================================        QLabel* labelOpen = new QLabel("<b>Open State</b><br>(Active Step)", this);    labelOpen->setAlignment(Qt::AlignRight | Qt::AlignVCenter);    lay->addWidget(labelOpen, 1, 0, Qt::AlignRight);        // OPEN PRESET CONTAINER    {        QWidget* container = new QWidget(this);        QVBoxLayout* vlay = new QVBoxLayout(container);                // FIX: Add Left Margin (25px) to nudge the Preset Knob/Text to the RIGHT        // setContentsMargins(left, top, right, bottom)        vlay->setContentsMargins(25, 0, 0, 0);         vlay->setSpacing(0);        vlay->setAlignment(Qt::AlignCenter);                 Knob* k = new Knob(KnobType::Bright26, "Preset", this);        k->setModel(&c->m_openPresetModel);        k->setToolTip("1 = Use Text Formula below.\n2-17 = Built-in shapes.");                m_openPresetNameLabel = new QLabel("Custom", this);        m_openPresetNameLabel->setAlignment(Qt::AlignCenter);        m_openPresetNameLabel->setFixedWidth(110);         m_openPresetNameLabel->setStyleSheet("font-size: 9px; color: #00FF00; font-weight: bold;");                vlay->addWidget(k);        vlay->addWidget(m_openPresetNameLabel);                lay->addWidget(container, 1, 1, Qt::AlignCenter);                connect(&c->m_openPresetModel, &FloatModel::dataChanged,                 this, &SpectralGateControlDialog::updatePresetLabels);    }        {        Knob* k = new Knob(KnobType::Bright26, "Low", this);        k->setModel(&c->m_openLowModel);        lay->addWidget(k, 1, 2, Qt::AlignCenter);    }    {        Knob* k = new Knob(KnobType::Bright26, "Mid", this);        k->setModel(&c->m_openMidModel);        lay->addWidget(k, 1, 3, Qt::AlignCenter);    }    {        Knob* k = new Knob(KnobType::Bright26, "High", this);        k->setModel(&c->m_openHighModel);        lay->addWidget(k, 1, 4, Qt::AlignCenter);    }    // ============================================================    // ROW 2: CLOSED EQ (Bottom Row)    // ============================================================        QLabel* labelClosed = new QLabel("<b>Closed State</b><br>(Inactive Step)", this);    labelClosed->setAlignment(Qt::AlignRight | Qt::AlignVCenter);    lay->addWidget(labelClosed, 2, 0, Qt::AlignRight);        // CLOSED PRESET CONTAINER    {        QWidget* container = new QWidget(this);        QVBoxLayout* vlay = new QVBoxLayout(container);                // FIX: Add Left Margin (25px) here too        vlay->setContentsMargins(25, 0, 0, 0);        vlay->setSpacing(0);        vlay->setAlignment(Qt::AlignCenter);        Knob* k = new Knob(KnobType::Bright26, "Preset", this);        k->setModel(&c->m_closedPresetModel);                m_closedPresetNameLabel = new QLabel("Lowpass", this);        m_closedPresetNameLabel->setAlignment(Qt::AlignCenter);        m_closedPresetNameLabel->setFixedWidth(110);        m_closedPresetNameLabel->setStyleSheet("font-size: 9px; color: #FF0000; font-weight: bold;");                vlay->addWidget(k);        vlay->addWidget(m_closedPresetNameLabel);                lay->addWidget(container, 2, 1, Qt::AlignCenter);                connect(&c->m_closedPresetModel, &FloatModel::dataChanged,                 this, &SpectralGateControlDialog::updatePresetLabels);    }    {        Knob* k = new Knob(KnobType::Bright26, "Low", this);        k->setModel(&c->m_closedLowModel);        lay->addWidget(k, 2, 2, Qt::AlignCenter);    }    {        Knob* k = new Knob(KnobType::Bright26, "Mid", this);        k->setModel(&c->m_closedMidModel);        lay->addWidget(k, 2, 3, Qt::AlignCenter);    }    {        Knob* k = new Knob(KnobType::Bright26, "High", this);        k->setModel(&c->m_closedHighModel);        lay->addWidget(k, 2, 4, Qt::AlignCenter);    }    // --- ROW 3: INFO TEXT ---    QLabel* info = new QLabel(        "<i>Logic: Final Output = (Formula) * (Low/Mid/High Knobs). "        "Preset must be 1 to use Formula.</i><br>"        "<b>1</b> = Pass (Multiply by 1.0) | <b>0</b> = Silence (Multiply by 0.0)<br>"        "<span style='color:#aaaaaa;'>Note: If a Preset cuts a frequency range (e.g. LPF cuts Highs), "        "the corresponding EQ dial will be ineffective.</span>",         this);    info->setStyleSheet("margin-top: 5px; color: #dddddd;");    lay->addWidget(info, 3, 0, 1, 6);    // --- ROW 4: FORMULA HEADER ---    QLabel* formulaHeader = new QLabel("FORMULA ENTRY", this);    formulaHeader->setAlignment(Qt::AlignCenter);    formulaHeader->setStyleSheet("font-weight: bold; color: #00FFFF; margin-top: 10px;");    lay->addWidget(formulaHeader, 4, 0, 1, 6);    // --- ROW 5: FORMULA LABELS ---    QLabel* lblOpen = new QLabel("OPEN STATE FORMULA FOR PRESET 1", this);    lblOpen->setStyleSheet("font-weight: bold; font-size: 10px; color: #ffffff;");    lay->addWidget(lblOpen, 5, 0, 1, 3);    QLabel* lblClosed = new QLabel("CLOSED STATE FORMULA FOR PRESET 1", this);    lblClosed->setStyleSheet("font-weight: bold; font-size: 10px; color: #ffffff;");    lay->addWidget(lblClosed, 5, 3, 1, 3);    // --- ROW 6: FORMULA INPUTS ---    m_openFormulaEdit = new QLineEdit(this);    m_openFormulaEdit->setPlaceholderText("Open Formula (e.g. 1)");    m_openFormulaEdit->setText(c->getOpenFormula());    connect(m_openFormulaEdit, &QLineEdit::textChanged,            c, &SpectralGateControls::setOpenFormula);    lay->addWidget(m_openFormulaEdit, 6, 0, 1, 3);    m_closedFormulaEdit = new QLineEdit(this);    m_closedFormulaEdit->setPlaceholderText("Closed Formula (e.g. 0)");    m_closedFormulaEdit->setText(c->getClosedFormula());    connect(m_closedFormulaEdit, &QLineEdit::textChanged,            c, &SpectralGateControls::setClosedFormula);    lay->addWidget(m_closedFormulaEdit, 6, 3, 1, 3);    // --- ROW 7: BUTTONS ---    QWidget* btnContainer = new QWidget(this);    QHBoxLayout* btnLay = new QHBoxLayout(btnContainer);    btnLay->setContentsMargins(0,0,0,0);    btnLay->setSpacing(4);        for (int i = 0; i < 16; ++i)    {        QPushButton* b = new QPushButton(QString::number(i+1), this);        b->setCheckable(true);        b->setProperty("stepIndex", i);        b->setFixedSize(32, 30);        connect(b, &QPushButton::clicked,                this, &SpectralGateControlDialog::onButtonClicked);        m_stepButtons.push_back(b);        btnLay->addWidget(b);    }    lay->addWidget(btnContainer, 7, 0, 1, 6);    // ============================================================    // RIGHT COLUMN: CHEAT SHEET    // ============================================================    QGroupBox* cheatGroup = new QGroupBox("Formula Examples", this);    QVBoxLayout* cheatLay = new QVBoxLayout(cheatGroup);        QLabel* examples = new QLabel(        "<b>Flat / Normal:</b><br>"        " 1<br><br>"        "<b>Silence:</b><br>"        " 0<br><br>"        "<b>Hard Cut (Lowpass):</b><br>"        " (freq &lt; 1000) ? 1 : 0<br><br>"        "<b>Metallic Comb:</b><br>"        " abs(sin(freq/100))<br><br>"        "<b>Dark Slope:</b><br>"        " exp(-0.002 * freq)<br><br>"        "<b>Notch Filter:</b><br>"        " abs(freq - 1000) &gt; 200",         this);            examples->setTextInteractionFlags(Qt::TextSelectableByMouse);     cheatLay->addWidget(examples);    cheatLay->addStretch();        lay->addWidget(cheatGroup, 0, 6, 8, 1);        for(int c=0; c<=5; ++c) lay->setColumnStretch(c, 1);    lay->setColumnStretch(6, 2);     connect(c, &SpectralGateControls::stepsChanged,            this, &SpectralGateControlDialog::updateButtonsFromModel);    connect(&c->m_patternModel, &FloatModel::dataChanged,            this, &SpectralGateControlDialog::updateButtonsFromModel);    connect(c, &SpectralGateControls::runIndexChanged,            this, &SpectralGateControlDialog::onRunIndexChanged);    updateButtonsFromModel();    updatePresetLabels();}QString SpectralGateControlDialog::getPresetName(int index){    switch(index) {        case 1: return "Custom (Formula)";        case 2: return "Lowpass (Soft)";        case 3: return "Highpass (Hard)";        case 4: return "Low Shelf";        case 5: return "High Shelf";        case 6: return "Bandpass";        case 7: return "Notch";        case 8: return "Peak Boost";        case 9: return "Comb (+)";        case 10: return "Comb (-)";        case 11: return "Allpass";        case 12: return "Spectral Chop";        case 13: return "High Damp";        case 14: return "Vowel A";        case 15: return "Vowel E";        case 16: return "Ripple";        case 17: return "Dispersion";        default: return "Unknown";    }}void SpectralGateControlDialog::updatePresetLabels(){    int openIdx = (int)m_controls->m_openPresetModel.value();    int closedIdx = (int)m_controls->m_closedPresetModel.value();        m_openPresetNameLabel->setText(getPresetName(openIdx));    m_closedPresetNameLabel->setText(getPresetName(closedIdx));}void SpectralGateControlDialog::onButtonClicked(){    QPushButton* b = qobject_cast<QPushButton*>(sender());    if (!b) return;    int idx = b->property("stepIndex").toInt();    int pat = (int)m_controls->m_patternModel.value();    m_controls->setStep(pat, idx, b->isChecked());}void SpectralGateControlDialog::updateButtonsFromModel(){    int pat = (int)m_controls->m_patternModel.value();    for (int i = 0; i < 16; ++i)    {        m_stepButtons[i]->blockSignals(true);        m_stepButtons[i]->setChecked(m_controls->getStep(pat, i));        m_stepButtons[i]->blockSignals(false);    }}void SpectralGateControlDialog::onRunIndexChanged(int idx){    for (int i = 0; i < 16; ++i)    {        if (i == idx)            m_stepButtons[i]->setStyleSheet("background-color:#00FFFF;");        else if (m_stepButtons[i]->isChecked())            m_stepButtons[i]->setStyleSheet("background-color:#00FF00;");        else            m_stepButtons[i]->setStyleSheet("background-color:#880000;");    }}} // namespace lmms::gui