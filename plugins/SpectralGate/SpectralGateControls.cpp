#include "SpectralGateControls.h"#include "SpectralGateControlDialog.h"#include "SpectralGate.h"#include <QDomElement>namespace lmms{SpectralGateControls::SpectralGateControls(SpectralGateEffect* effect) :    EffectControls(effect),    // Gate    m_patternModel(0.f, 0.f, 3.f, 1.f, this, tr("Pattern")),    m_smoothModel(0.f, 0.f, 1.f, 0.01f, this, tr("Smooth")),    m_swingModel(0.f, 0.f, 1.f, 0.01f, this, tr("Swing")),    m_speedModel(1.f, 0.5f, 4.f, 0.5f, this, tr("Speed")),        // Global DSP (New)    m_widthModel(0.f, 0.f, 1.f, 0.01f, this, tr("Width")),    m_decayModel(0.f, 0.f, 0.95f, 0.01f, this, tr("Decay")), // Cap at 0.95 to prevent explosion    // Presets    m_openPresetModel(1.f, 1.f, 17.f, 1.f, this, tr("OpenEQ")),    m_closedPresetModel(6.f, 1.f, 17.f, 1.f, this, tr("ClosedEQ")),    // Open EQ (Defaults to Flat 1.0)    m_openLowModel(1.f, 0.f, 2.f, 0.01f, this, tr("Opn Low")),    m_openMidModel(1.f, 0.f, 2.f, 0.01f, this, tr("Opn Mid")),    m_openHighModel(1.f, 0.f, 2.f, 0.01f, this, tr("Opn Hi")),    // Closed EQ (Defaults to Low Pass)    m_closedLowModel(1.f, 0.f, 2.f, 0.01f, this, tr("Cls Low")),    m_closedMidModel(0.f, 0.f, 2.f, 0.01f, this, tr("Cls Mid")),    m_closedHighModel(0.f, 0.f, 2.f, 0.01f, this, tr("Cls Hi")),        m_effect(effect){    // Allocate patterns    m_patterns.resize(4, std::vector<bool>(16, false));    // Default patterns    for (int i = 0; i < 16; ++i) m_patterns[0][i] = (i % 2 == 0);    for (int i = 0; i < 16; ++i) m_patterns[1][i] = (i % 4 == 0);    for (int i = 0; i < 16; ++i) m_patterns[2][i] = true;    for (int i = 0; i < 16; ++i) m_patterns[3][i] = (i % 2 != 0);    m_openFormulaString   = "1";     m_closedFormulaString = "0"; }gui::EffectControlDialog* SpectralGateControls::createView(){    return new gui::SpectralGateControlDialog(this);}void SpectralGateControls::setStep(int p, int i, bool active){    if (p >= 0 && p < 4 && i >= 0 && i < 16)    {        m_patterns[p][i] = active;        emit stepsChanged();    }}bool SpectralGateControls::getStep(int p, int i) const{    if (p >= 0 && p < 4 && i >= 0 && i < 16)        return m_patterns[p][i];    return false;}bool SpectralGateControls::getCurrentStep(int i) const{    int p = static_cast<int>(m_patternModel.value());    return getStep(p, i);}void SpectralGateControls::setRunIndex(int index){    if (index != m_runIndex)    {        m_runIndex = index;        emit runIndexChanged(index);    }}void SpectralGateControls::setOpenFormula(const QString& t){    m_openFormulaString = t;}void SpectralGateControls::setClosedFormula(const QString& t){    m_closedFormulaString = t;}void SpectralGateControls::saveSettings(QDomDocument& doc, QDomElement& parent){    m_patternModel.saveSettings(doc, parent, "pattern");    m_smoothModel.saveSettings(doc, parent, "smooth");    m_swingModel.saveSettings(doc, parent, "swing");    m_speedModel.saveSettings(doc, parent, "speed");        // New Params    m_widthModel.saveSettings(doc, parent, "width");    m_decayModel.saveSettings(doc, parent, "decay");    m_openPresetModel.saveSettings(doc, parent, "open_preset");    m_closedPresetModel.saveSettings(doc, parent, "closed_preset");    m_openLowModel.saveSettings(doc, parent, "open_low");    m_openMidModel.saveSettings(doc, parent, "open_mid");    m_openHighModel.saveSettings(doc, parent, "open_high");    m_closedLowModel.saveSettings(doc, parent, "closed_low");    m_closedMidModel.saveSettings(doc, parent, "closed_mid");    m_closedHighModel.saveSettings(doc, parent, "closed_high");    parent.setAttribute("open_formula",   m_openFormulaString);    parent.setAttribute("closed_formula", m_closedFormulaString);    QString labels[4] = {"seqA","seqB","seqC","seqD"};    for (int p = 0; p < 4; ++p)    {        QString seq = "";        for (bool s : m_patterns[p])            seq += (s ? "1" : "0");        parent.setAttribute(labels[p], seq);    }}void SpectralGateControls::loadSettings(const QDomElement& parent){    m_patternModel.loadSettings(parent, "pattern");    m_smoothModel.loadSettings(parent, "smooth");    m_swingModel.loadSettings(parent, "swing");    m_speedModel.loadSettings(parent, "speed");    m_widthModel.loadSettings(parent, "width");    m_decayModel.loadSettings(parent, "decay");    m_openPresetModel.loadSettings(parent, "open_preset");    m_closedPresetModel.loadSettings(parent, "closed_preset");    m_openLowModel.loadSettings(parent, "open_low");    m_openMidModel.loadSettings(parent, "open_mid");    m_openHighModel.loadSettings(parent, "open_high");    m_closedLowModel.loadSettings(parent, "closed_low");    m_closedMidModel.loadSettings(parent, "closed_mid");    m_closedHighModel.loadSettings(parent, "closed_high");    if (parent.hasAttribute("open_formula"))        m_openFormulaString = parent.attribute("open_formula");    if (parent.hasAttribute("closed_formula"))        m_closedFormulaString = parent.attribute("closed_formula");    QString labels[4] = {"seqA","seqB","seqC","seqD"};    for (int p = 0; p < 4; ++p)    {        if (parent.hasAttribute(labels[p]))        {            QString seq = parent.attribute(labels[p]);            for (int i = 0; i < 16 && i < seq.length(); ++i)                m_patterns[p][i] = (seq[i] == '1');        }    }    emit stepsChanged();}} // namespace lmms